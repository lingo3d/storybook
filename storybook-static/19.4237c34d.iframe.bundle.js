(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{"./node_modules/lingo3d/lib/display/core/SimpleObjectManager/PhysicsItem/enableBVHCharacter.js":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var three_module=__webpack_require__("./node_modules/three/build/three.module.js"),scene=__webpack_require__("./node_modules/lingo3d/lib/engine/scene/index.js"),getActualScale=__webpack_require__("./node_modules/lingo3d/lib/display/utils/getActualScale.js"),lib=__webpack_require__("./node_modules/@lincode/reactivity/lib/index.js"),utils_lib=__webpack_require__("./node_modules/@lincode/utils/lib/index.js"),eventLoop=__webpack_require__("./node_modules/lingo3d/lib/engine/eventLoop.js"),useBVHMap=__webpack_require__("./node_modules/lingo3d/lib/states/useBVHMap.js"),useEditorActive=__webpack_require__("./node_modules/lingo3d/lib/states/useEditorActive.js"),useGravity=__webpack_require__("./node_modules/lingo3d/lib/states/useGravity.js"),useRepulsion=__webpack_require__("./node_modules/lingo3d/lib/states/useRepulsion.js"),reusables=__webpack_require__("./node_modules/lingo3d/lib/display/utils/reusables.js"),bvhContactMap=__webpack_require__("./node_modules/lingo3d/lib/display/core/SimpleObjectManager/PhysicsItem/bvh/bvhContactMap.js"),computeBVH=__webpack_require__("./node_modules/lingo3d/lib/display/core/SimpleObjectManager/PhysicsItem/bvh/computeBVH.js");const bvhCharacterSet=new Set,makeWeakSet=()=>new WeakSet;Object(lib.b)((function(){if(Object(useEditorActive.a)())return;const bvhArray=Object(useBVHMap.a)();if(!bvhArray.length)return;const gravity=Object(useGravity.a)(),repulsion=Object(useRepulsion.a)(),handle=Object(eventLoop.a)((()=>{bvhContactMap.a.clear();for(const characterManager of bvhCharacterSet){const playerVelocity=characterManager.bvhVelocity,player=characterManager.outerObject3d,capsuleHalfHeight=characterManager.bvhHalfHeight,capsuleRadius=characterManager.bvhRadius;playerVelocity.y+=characterManager.bvhOnGround?0:.02*-gravity;const{position:position}=characterManager.physicsUpdate;characterManager.physicsUpdate={},position&&(position.x&&(playerVelocity.x=0),position.y&&(playerVelocity.y=0),position.z&&(playerVelocity.z=0)),player.position.addScaledVector(playerVelocity,.02),player.updateMatrixWorld();const{start:start,end:end}=reusables.d;end.copy(start.copy(player.position));const yOffset=Math.max(capsuleHalfHeight-capsuleRadius,0);end.y+=yOffset,start.y-=yOffset;const startOld=start.clone();reusables.a.setFromCenterAndSize(player.position,reusables.l.set(2*capsuleRadius,2*capsuleHalfHeight,2*capsuleRadius));const triPoint=reusables.i,capsulePoint=reusables.j;let direction,mapManager,distance=0,contact=!1;for(const boundsTree of bvhArray)mapManager=computeBVH.a.get(boundsTree),boundsTree.shapecast({intersectsBounds:box=>box.intersectsBox(reusables.a),intersectsTriangle:tri=>{distance=tri.closestPointToSegment(reusables.d,triPoint,capsulePoint),distance<capsuleRadius&&(contact=!0,direction=capsulePoint.sub(triPoint).normalize().multiplyScalar(capsuleRadius-distance),start.add(direction),end.add(direction))}});contact&&mapManager&&Object(utils_lib.e)(bvhContactMap.a,characterManager,makeWeakSet).add(mapManager);const deltaVector=start.sub(startOld);characterManager.bvhOnGround=deltaVector.y>Math.abs(.02*playerVelocity.y*.25),repulsion&&characterManager.bvhOnGround&&Math.abs(deltaVector.y/(deltaVector.x+deltaVector.z+Number.EPSILON))<repulsion&&(characterManager.bvhOnGround=!1);const offset=Math.max(0,deltaVector.length()-1e-5);deltaVector.normalize().multiplyScalar(offset),player.position.add(deltaVector),characterManager.bvhOnGround?playerVelocity.set(0,0,0):(deltaVector.normalize(),playerVelocity.addScaledVector(deltaVector,-deltaVector.dot(playerVelocity)))}}));return()=>{handle.cancel()}}),[useBVHMap.a,useGravity.a,useRepulsion.a,useEditorActive.a]);__webpack_exports__.default=function(handle){if(handle.done)return;scene.a.attach(this.outerObject3d),this.width=this.depth=Math.min(this.width,this.depth),this.physicsUpdate={};const actualScale=Object(getActualScale.a)(this).multiplyScalar(.5);this.bvhHalfHeight=Math.max(actualScale.y,.5),this.bvhRadius=Math.max(actualScale.x,.5),this.bvhVelocity=new three_module.ud,bvhCharacterSet.add(this),handle.then((()=>{bvhCharacterSet.delete(this),this.physicsUpdate=void 0}))}}}]);